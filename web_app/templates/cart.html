{% load static %}

{% load math %}

{% include "partials/header.html" %}

<div class="dummy"></div>

<div class="container cart-page mb-5">
    {% if products_by_vendor %}
    {% for vendor in products_by_vendor %}
    <div class="row rounded cart-container mb-4 shadow-sm">
        <div class="vendorname border-bottom p-3">
            <a href="/products/vendor/{{ vendor.vendor.username }}" class="text-decoration-none text-reset">
                <span class="text">
                    <i class="bi bi-shop-window"></i>
                    {{ vendor.vendor.name }}
                    <i class="bi bi-chevron-right"></i>
                </span>
            </a>
        </div>

        {% for cart_product in vendor.cart_products %}
        <div class="row vendor-products p-3">
            <div class="col-1 d-flex justify-content-center align-items-center select-col">
                <input type="checkbox" value="{{ cart_product.product.id }}"
                    class="form-check-input product-checkbox pd-checkbox-{{ cart_product.product.id }}"
                    oninput="selectOne('{{ cart_product.product.id }}')">
            </div>

            <div class="col pd-img d-flex justify-content-center align-items-center mb-3">
                <a href="/product/{{ cart_product.product.id }}" class="text-decoration-none text-reset">
                    <div class="image">
                        <img class="img-fluid" src="{% static 'images/products/' %}{{ cart_product.product.images.0 }}"
                            alt="product-img">
                    </div>
                </a>
            </div>

            <div class="col-7 col-md-8 pd-info d-flex align-items-center mb-3">
                <div class="col pd-name text-start">
                    <a href="/product/{{ cart_product.product.id }}" class="text-decoration-none text-reset">
                        {{ cart_product.product.name }}
                    </a>
                </div>

                <div class="col pd-price text-center">
                    $
                    <span class="pd-price-{{ cart_product.product.id }}">
                        {{ cart_product.product.price }}
                    </span>
                </div>

                <div class="col-6 col-sm-5 col-md-4 col-lg-3 pd-quantity position-relative">
                    <div class="pd-quantity-input d-flex flex-row">
                        <div class="input-group">
                            <div class="input-group-btn">
                                <button type="button" class="btn btn-default btn-number"
                                    onclick="editQuantity('{{ cart_product.product.id }}', 'remove', 1)">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>

                            <input type="number" step="any" name="quant[1]"
                                class="text-center form-control input-number pd-quantity-input-box-{{ cart_product.product.id }}"
                                value="{{ cart_product.quantity }}" min="1" onfocus="this.oldvalue = this.value;"
                                onchange="editQuantity('{{ cart_product.product.id }}', 'edit', oldvalue=this.oldvalue);this.oldvalue = this.value;">
                            <!-- leave this onchange instead of oninput because fetch is required, oninput may overload backend -->

                            <div class="input-group-btn">
                                <button type="button" class="btn btn-default btn-number"
                                    onclick="editQuantity('{{ cart_product.product.id }}', 'add', 1)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="stock position-absolute">
                        <span>Stock: </span>
                        <span class="pd-stock-{{ cart_product.product.id }}">
                            {{ cart_product.product.stock }}
                        </span>
                    </div>

                </div>

                <div class="col pd-total-price d-none d-lg-block text-center">
                    $
                    <span class="pd-total-price-{{ cart_product.product.id }}">
                        {{ cart_product.product.price|products_price:cart_product.quantity }}
                    </span>
                </div>
            </div>

            <div class="col-1 pd-remove d-none d-lg-flex justify-content-center align-items-center mb-3">
                <div class="modal fade add-card-modal" id="removeCartPd-{{ cart_product.product.id }}"
                    data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="removeCartPdLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="removeCartPdLabel">Do you want to remove this product?
                                </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary w-25"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger w-25"
                                    onclick="editQuantity('{{ cart_product.product.id }}', 'remove', 'all')">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn anm-btn pd-remove-btn btn-danger" data-bs-toggle="modal"
                    data-bs-target="#removeCartPd-{{ cart_product.product.id }}">Remove</button>
            </div>

            {% if not forloop.last %}
            <div class="col-12 border-bottom"></div>
            {% endif %}

        </div>
        {% endfor %}
    </div>
    {% endfor %}
    {% endif %}

    {% if out_of_stock_products %}
    <div class="alert alert-warning out-of-stock-warning" role="alert">
        <h5 class="alert-heading m-0">Some products are out of stock!</h5>
    </div>
    {% for vendor in out_of_stock_products %}
    <div class="row rounded cart-container mb-4 shadow-sm">
        <div class="vendorname border-bottom p-3">
            <a href="/products/vendor/{{ vendor.vendor.username }}" class="text-decoration-none text-reset">
                <span class="text">
                    <i class="bi bi-shop-window"></i>
                    {{ vendor.vendor.name }}
                    <i class="bi bi-chevron-right"></i>
                </span>
            </a>
        </div>

        {% for cart_product in vendor.cart_products %}
        <div class="row vendor-products p-3">
            <div class="col-1 d-flex justify-content-center align-items-center select-col">
                <input type="checkbox" value="out-of-stock"
                    class="form-check-input product-checkbox pd-checkbox-{{ cart_product.product.id }}" disabled>
            </div>

            <div class="col pd-img d-flex justify-content-center align-items-center mb-3">
                <a href="/product/{{ cart_product.product.id }}" class="text-decoration-none text-reset">
                    <div class="image">
                        <img class="img-fluid" src="{% static 'images/products/' %}{{ cart_product.product.images.0 }}"
                            alt="product-img" style="opacity: 0.5;">
                    </div>
                </a>
            </div>

            <div class="col-7 col-md-8 pd-info d-flex align-items-center mb-3">
                <div class="col pd-name text-start" style="color: rgba(0, 0, 0, 0.5);">
                    <a href="/product/{{ cart_product.product.id }}" class="text-decoration-none text-reset">
                        {{ cart_product.product.name }}
                    </a>
                </div>

                <div class="col pd-price text-center" style="color: rgba(0, 0, 0, 0.5);">
                    $
                    <span class="pd-price-{{ cart_product.product.id }}">
                        {{ cart_product.product.price }}
                    </span>
                </div>

                <div class="col-6 col-sm-5 col-md-4 col-lg-3 pd-quantity text-center"
                    style="color: rgba(0, 0, 0, 0.5);">
                    <div class="stock">
                        <span>Stock: </span>
                        <span class="pd-stock-{{ cart_product.product.id }}">
                            {{ cart_product.product.stock }}
                        </span>
                    </div>
                </div>

                <div class="col pd-out-of-stock d-none d-lg-block text-center">
                    <span class="text-danger">
                        Out of stock
                    </span>
                </div>
            </div>

            <div class="col-1 pd-remove d-none d-lg-flex justify-content-center align-items-center mb-3">
                <div class="modal fade add-card-modal" id="removeCartPd-{{ cart_product.product.id }}"
                    data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="removeCartPdLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="removeCartPdLabel">Do you want to remove this product?
                                </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary w-25"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger w-25"
                                    onclick="editQuantity('{{ cart_product.product.id }}', 'remove', 'all')">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn anm-btn pd-remove-btn btn-danger" data-bs-toggle="modal"
                    data-bs-target="#removeCartPd-{{ cart_product.product.id }}">Remove</button>
            </div>

            {% if not forloop.last %}
            <div class="col-12 border-bottom"></div>
            {% endif %}

        </div>
        {% endfor %}
    </div>
    {% endfor %}
    {% endif %}

    {% if not products_by_vendor and not out_of_stock_products %}
    <div class="row rounded cart-container empty-cart text-center shadow-sm">
        <h2>You haven't add any products to your cart yet.</h2>
    </div>
    {% endif %}

    <div class="row checkout-container rounded shadow-sm p-3">
        <div class="col d-flex align-items-center select-all-wrapper">
            <div calss="form-check">
                <input type="checkbox" class="form-check-input select-all" id="select-all" oninput="selectAll()">
                <label class="form-check-label" for="select-all">Select All</label>
            </div>
        </div>

        <div class="col d-flex justify-content-center align-items-center gap-4">
            <div class="cart-total-price">
                Total: <span class="dolar">$</span>
                <span class="total-price">
                    {{ total_price }}
                </span>
            </div>

            <div class="checkout">
                <form class="checkout-form" method="POST" action="/checkout/">
                    <input type="hidden" class="checkout-mode" id="mode" name="mode">
                    <input type="hidden" class="checkout-pd-ids" id="product_ids" name="product_ids">
                    <button type="button" onclick="checkOutCart()" disabled
                        class="btn btn-primary checkout-btn anm-btn">
                        <span>Checkout</span></button>
                </form>
            </div>
        </div>
    </div>

</div>

{% include "partials/footer.html" %}